{% extends "core/base.html" %}

{% block title %}Reports · Broker Portal{% endblock %}
{% block page_title %}Reports & Analytics{% endblock %}
{% block page_subtitle %}Comprehensive insights into your business performance{% endblock %}

{% block content %}
<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- Time Travel Section -->
<div style="background: var(--bg-content); border-radius: 8px; padding: 20px; border: 1px solid var(--border); margin-bottom: 24px;">
    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px;">
        <div>
            <h2 style="font-size: 18px; font-weight: 600; margin: 0 0 8px 0;">Time Travel Report</h2>
            <p style="margin: 0; font-size: 14px; color: var(--muted);">View historical data for any date range</p>
        </div>
        <form method="get" style="display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap;">
            <input type="hidden" name="report_type" value="{{ report_type }}">
            <div>
                <label class="field-label" style="margin: 0 0 4px 0;">Start Date</label>
                <input type="date" name="start_date" value="{{ start_date_str|default:'' }}" class="field-input" style="min-width: 150px;">
            </div>
            <div>
                <label class="field-label" style="margin: 0 0 4px 0;">End Date</label>
                <input type="date" name="end_date" value="{{ end_date_str|default:'' }}" class="field-input" style="min-width: 150px;">
            </div>
            <div style="display: flex; gap: 8px;">
                <button type="submit" class="btn btn-primary">View Report</button>
                {% if time_travel_mode %}
                <a href="?report_type={{ report_type }}" class="btn">Clear</a>
                {% endif %}
            </div>
        </form>
    </div>
    {% if time_travel_mode %}
    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
        <div style="font-size: 14px; color: var(--muted);">
            {% if start_date_str and end_date_str %}
                Showing data from <strong>{{ start_date_str }}</strong> to <strong>{{ end_date_str }}</strong>
            {% elif as_of_str %}
                Showing all data up to <strong>{{ as_of_str }}</strong>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Report Type Tabs -->
<div style="background: var(--bg-content); border-radius: 8px; padding: 0; border: 1px solid var(--border); margin-bottom: 24px; overflow: hidden;">
    <div style="display: flex; border-bottom: 1px solid var(--border);">
        <a href="?report_type=daily" style="flex: 1; padding: 16px 20px; text-align: center; text-decoration: none; color: var(--text); border-right: 1px solid var(--border); background: {% if report_type == 'daily' %}#f9fafb{% else %}transparent{% endif %}; font-weight: {% if report_type == 'daily' %}600{% else %}400{% endif %}; font-size: 15px; {% if report_type == 'daily' %}border-bottom: 2px solid var(--accent); margin-bottom: -1px;{% endif %}">
            Daily Report
        </a>
        <a href="?report_type=weekly" style="flex: 1; padding: 16px 20px; text-align: center; text-decoration: none; color: var(--text); border-right: 1px solid var(--border); background: {% if report_type == 'weekly' %}#f9fafb{% else %}transparent{% endif %}; font-weight: {% if report_type == 'weekly' %}600{% else %}400{% endif %}; font-size: 15px; {% if report_type == 'weekly' %}border-bottom: 2px solid var(--accent); margin-bottom: -1px;{% endif %}">
            Weekly Report
        </a>
        <a href="?report_type=monthly" style="flex: 1; padding: 16px 20px; text-align: center; text-decoration: none; color: var(--text); background: {% if report_type == 'monthly' %}#f9fafb{% else %}transparent{% endif %}; font-weight: {% if report_type == 'monthly' %}600{% else %}400{% endif %}; font-size: 15px; {% if report_type == 'monthly' %}border-bottom: 2px solid var(--accent); margin-bottom: -1px;{% endif %}">
            Monthly Report
        </a>
    </div>
</div>

<!-- Summary Cards -->
<div class="card-grid" style="margin-bottom: 24px;">
    <div class="card">
        <div class="card-title">Total Turnover</div>
        <div class="card-value">₹ {{ total_turnover|default:0|floatformat:2 }}</div>
        <div style="margin-top: 8px; font-size: 13px; color: var(--muted);">All-time transaction volume</div>
    </div>
    <div class="card">
        <div class="card-title">Your Total Profit</div>
        <div class="card-value positive">₹ {{ your_total_profit|default:0|floatformat:2 }}</div>
        <div style="margin-top: 8px; font-size: 13px; color: var(--muted);">Your share from profits</div>
    </div>
    <div class="card">
        <div class="card-title">Company Profit</div>
        <div class="card-value">₹ {{ company_profit|default:0|floatformat:2 }}</div>
        <div style="margin-top: 8px; font-size: 13px; color: var(--muted);">Company share from transactions</div>
    </div>
</div>

{% if report_type == 'daily' %}
<!-- Daily Report Section -->
<div style="margin-bottom: 24px;">
    <div style="background: var(--bg-content); border-radius: 8px; padding: 20px; border: 1px solid var(--border);">
        <h2 style="font-size: 18px; font-weight: 600; margin: 0 0 20px 0;">Daily Trends (Last 30 Days)</h2>
        <canvas id="dailyTrendsChart" style="max-height: 400px;"></canvas>
    </div>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 20px; margin-bottom: 24px;">
    <div style="background: var(--bg-content); border-radius: 8px; padding: 20px; border: 1px solid var(--border);">
        <h2 style="font-size: 18px; font-weight: 600; margin: 0 0 20px 0;">Transaction Type Breakdown</h2>
        <canvas id="typeBreakdownChart" style="max-height: 320px;"></canvas>
    </div>
    
    {% if client_labels %}
    <div style="background: var(--bg-content); border-radius: 8px; padding: 20px; border: 1px solid var(--border);">
        <h2 style="font-size: 18px; font-weight: 600; margin: 0 0 20px 0;">Top Clients by Profit (Last 30 Days)</h2>
        <canvas id="topClientsChart" style="max-height: 320px;"></canvas>
    </div>
    {% endif %}
</div>

{% elif report_type == 'weekly' %}
<!-- Weekly Report Section -->
<div style="margin-bottom: 24px;">
    <div style="background: var(--bg-content); border-radius: 8px; padding: 20px; border: 1px solid var(--border);">
        <h2 style="font-size: 18px; font-weight: 600; margin: 0 0 20px 0;">Weekly Trends (Last 4 Weeks)</h2>
        <canvas id="weeklyTrendsChart" style="max-height: 400px;"></canvas>
    </div>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 20px; margin-bottom: 24px;">
    <div style="background: var(--bg-content); border-radius: 8px; padding: 20px; border: 1px solid var(--border);">
        <h2 style="font-size: 18px; font-weight: 600; margin: 0 0 20px 0;">Transaction Type Breakdown</h2>
        <canvas id="typeBreakdownChart" style="max-height: 320px;"></canvas>
    </div>
    
    <div style="background: var(--bg-content); border-radius: 8px; padding: 20px; border: 1px solid var(--border);">
        <h2 style="font-size: 18px; font-weight: 600; margin: 0 0 20px 0;">Daily Trends (Last 30 Days)</h2>
        <canvas id="dailyTrendsChart" style="max-height: 320px;"></canvas>
    </div>
</div>

{% elif report_type == 'monthly' %}
<!-- Monthly Report Section -->
<div style="margin-bottom: 24px;">
    <div style="background: var(--bg-content); border-radius: 8px; padding: 20px; border: 1px solid var(--border);">
        <h2 style="font-size: 18px; font-weight: 600; margin: 0 0 20px 0;">Monthly Trends (Last 6 Months)</h2>
        <canvas id="monthlyTrendsChart" style="max-height: 400px;"></canvas>
    </div>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 20px; margin-bottom: 24px;">
    <div style="background: var(--bg-content); border-radius: 8px; padding: 20px; border: 1px solid var(--border);">
        <h2 style="font-size: 18px; font-weight: 600; margin: 0 0 20px 0;">Transaction Type Breakdown</h2>
        <canvas id="typeBreakdownChart" style="max-height: 320px;"></canvas>
    </div>
    
    <div style="background: var(--bg-content); border-radius: 8px; padding: 20px; border: 1px solid var(--border);">
        <h2 style="font-size: 18px; font-weight: 600; margin: 0 0 20px 0;">Weekly Trends (Last 4 Weeks)</h2>
        <canvas id="weeklyTrendsChart" style="max-height: 320px;"></canvas>
    </div>
</div>
{% endif %}

<!-- Time Travel Transactions Table -->
{% if time_travel_mode %}
<div style="margin-top: 24px;">
    <div style="background: var(--bg-content); border-radius: 8px; padding: 20px; border: 1px solid var(--border);">
        <h2 style="font-size: 18px; font-weight: 600; margin: 0 0 20px 0;">
            Transactions
            {% if start_date_str and end_date_str %}
                ({{ start_date_str }} to {{ end_date_str }})
            {% elif as_of_str %}
                (up to {{ as_of_str }})
            {% endif %}
        </h2>
        <div class="table-wrapper">
            <div class="table-header">
                <span>Showing latest {{ time_travel_transactions|length }} transactions</span>
            </div>
            <table>
                <thead>
                <tr>
                    <th>Date</th>
                    <th>Client</th>
                    <th>Exchange</th>
                    <th>Type</th>
                    <th>Amount</th>
                    <th>Your Share</th>
                    <th>Client Share</th>
                    <th>Company Share</th>
                </tr>
                </thead>
                <tbody>
                {% for tx in time_travel_transactions %}
                    <tr>
                        <td>{{ tx.date }}</td>
                        <td>{{ tx.client_exchange.client.name }}</td>
                        <td>{{ tx.client_exchange.exchange.name }}</td>
                        <td>
                            {% if tx.transaction_type == 'PROFIT' %}
                                <span class="badge badge-success">{{ tx.get_transaction_type_display }}</span>
                            {% elif tx.transaction_type == 'LOSS' %}
                                <span class="badge badge-muted">{{ tx.get_transaction_type_display }}</span>
                            {% elif tx.transaction_type == 'FUNDING' %}
                                <span class="badge badge-muted">{{ tx.get_transaction_type_display }}</span>
                            {% else %}
                                <span class="badge badge-muted">{{ tx.get_transaction_type_display }}</span>
                            {% endif %}
                        </td>
                        <td><strong>₹ {{ tx.amount|floatformat:2 }}</strong></td>
                        <td>₹ {{ tx.your_share_amount|default:0|floatformat:2 }}</td>
                        <td>₹ {{ tx.client_share_amount|default:0|floatformat:2 }}</td>
                        <td>₹ {{ tx.company_share_amount|default:0|floatformat:2 }}</td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: var(--muted);">
                            No transactions found
                            {% if start_date_str and end_date_str %}
                                between {{ start_date_str }} and {{ end_date_str }}
                            {% elif as_of_str %}
                                up to {{ as_of_str }}
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<script>
// Daily Trends Chart
{% if report_type == 'daily' or report_type == 'weekly' %}
const dailyCtx = document.getElementById('dailyTrendsChart').getContext('2d');
new Chart(dailyCtx, {
    type: 'line',
    data: {
        labels: {{ daily_labels }},
        datasets: [
            {
                label: 'Profit',
                data: {{ daily_profit }},
                borderColor: '#6b7280',
                backgroundColor: 'rgba(107, 114, 128, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 2
            },
            {
                label: 'Loss',
                data: {{ daily_loss }},
                borderColor: '#9ca3af',
                backgroundColor: 'rgba(156, 163, 175, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 2
            },
            {
                label: 'Turnover',
                data: {{ daily_turnover }},
                borderColor: '#4b5563',
                backgroundColor: 'rgba(75, 85, 99, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 2,
                yAxisID: 'y1'
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'top',
                labels: {
                    padding: 15,
                    font: {
                        size: 13
                    }
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                titleFont: {
                    size: 14
                },
                bodyFont: {
                    size: 13
                },
                callbacks: {
                    label: function(context) {
                        return context.dataset.label + ': ₹' + context.parsed.y.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                },
                ticks: {
                    font: {
                        size: 12
                    },
                    callback: function(value) {
                        return '₹' + value.toLocaleString('en-IN');
                    }
                }
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                beginAtZero: true,
                grid: {
                    drawOnChartArea: false,
                },
                ticks: {
                    font: {
                        size: 12
                    },
                    callback: function(value) {
                        return '₹' + value.toLocaleString('en-IN');
                    }
                },
            },
            x: {
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                },
                ticks: {
                    font: {
                        size: 12
                    }
                }
            }
        }
    }
});
{% endif %}

// Weekly Trends Chart
{% if report_type == 'weekly' or report_type == 'monthly' %}
const weeklyCtx = document.getElementById('weeklyTrendsChart').getContext('2d');
new Chart(weeklyCtx, {
    type: 'bar',
    data: {
        labels: {{ weekly_labels }},
        datasets: [
            {
                label: 'Profit',
                data: {{ weekly_profit }},
                backgroundColor: 'rgba(107, 114, 128, 0.6)',
                borderColor: '#6b7280',
                borderWidth: 1,
                borderRadius: 4
            },
            {
                label: 'Loss',
                data: {{ weekly_loss }},
                backgroundColor: 'rgba(156, 163, 175, 0.6)',
                borderColor: '#9ca3af',
                borderWidth: 1,
                borderRadius: 4
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'top',
                labels: {
                    padding: 15,
                    font: {
                        size: 13
                    }
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                titleFont: {
                    size: 14
                },
                bodyFont: {
                    size: 13
                },
                callbacks: {
                    label: function(context) {
                        return context.dataset.label + ': ₹' + context.parsed.y.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                },
                ticks: {
                    font: {
                        size: 12
                    },
                    callback: function(value) {
                        return '₹' + value.toLocaleString('en-IN');
                    }
                }
            },
            x: {
                grid: {
                    display: false
                },
                ticks: {
                    font: {
                        size: 12
                    }
                }
            }
        }
    }
});
{% endif %}

// Transaction Type Breakdown Chart
{% if report_type == 'daily' or report_type == 'weekly' or report_type == 'monthly' %}
const typeCtx = document.getElementById('typeBreakdownChart').getContext('2d');
new Chart(typeCtx, {
    type: 'doughnut',
    data: {
        labels: {{ type_labels }},
        datasets: [{
            data: {{ type_amounts }},
            backgroundColor: {{ type_colors }},
            borderWidth: 3,
            borderColor: '#ffffff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 15,
                    font: {
                        size: 13
                    }
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                titleFont: {
                    size: 14
                },
                bodyFont: {
                    size: 13
                },
                callbacks: {
                    label: function(context) {
                        const label = context.label || '';
                        const value = context.parsed || 0;
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = ((value / total) * 100).toFixed(1);
                        return label + ': ₹' + value.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' (' + percentage + '%)';
                    }
                }
            }
        }
    }
});
{% endif %}

// Monthly Trends Chart
{% if report_type == 'monthly' %}
const monthlyCtx = document.getElementById('monthlyTrendsChart').getContext('2d');
new Chart(monthlyCtx, {
    type: 'bar',
    data: {
        labels: {{ monthly_labels }},
        datasets: [
            {
                label: 'Profit',
                data: {{ monthly_profit }},
                backgroundColor: 'rgba(107, 114, 128, 0.6)',
                borderColor: '#6b7280',
                borderWidth: 1,
                borderRadius: 4
            },
            {
                label: 'Loss',
                data: {{ monthly_loss }},
                backgroundColor: 'rgba(156, 163, 175, 0.6)',
                borderColor: '#9ca3af',
                borderWidth: 1,
                borderRadius: 4
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'top',
                labels: {
                    padding: 15,
                    font: {
                        size: 13
                    }
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                titleFont: {
                    size: 14
                },
                bodyFont: {
                    size: 13
                },
                callbacks: {
                    label: function(context) {
                        return context.dataset.label + ': ₹' + context.parsed.y.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                },
                ticks: {
                    font: {
                        size: 12
                    },
                    callback: function(value) {
                        return '₹' + value.toLocaleString('en-IN');
                    }
                }
            },
            x: {
                grid: {
                    display: false
                },
                ticks: {
                    font: {
                        size: 12
                    }
                }
            }
        }
    }
});
{% endif %}

{% if report_type == 'daily' and client_labels %}
// Top Clients Chart
const clientsCtx = document.getElementById('topClientsChart').getContext('2d');
new Chart(clientsCtx, {
    type: 'bar',
    data: {
        labels: {{ client_labels }},
        datasets: [{
            label: 'Profit',
            data: {{ client_profits }},
            backgroundColor: 'rgba(107, 114, 128, 0.6)',
            borderColor: '#6b7280',
            borderWidth: 1,
            borderRadius: 4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        indexAxis: 'y',
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                titleFont: {
                    size: 14
                },
                bodyFont: {
                    size: 13
                },
                callbacks: {
                    label: function(context) {
                        return '₹' + context.parsed.x.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    }
                }
            }
        },
        scales: {
            x: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                },
                ticks: {
                    font: {
                        size: 12
                    },
                    callback: function(value) {
                        return '₹' + value.toLocaleString('en-IN');
                    }
                }
            },
            y: {
                grid: {
                    display: false
                },
                ticks: {
                    font: {
                        size: 12
                    }
                }
            }
        }
    }
});
{% endif %}
</script>
{% endblock %}
