{% extends "core/base.html" %}
{% load math_filters %}

{% block title %}Record Payment Â· Transaction Hub{% endblock %}
{% block page_title %}Record Payment{% endblock %}
{% block page_subtitle %}{{ account.client.name }} - {{ account.exchange.name }}{% endblock %}

{% block content %}
<div class="card" style="max-width: 500px;">
    {% if messages %}
        {% for message in messages %}
            <div style="padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; {% if message.tags == 'success' %}background: #d1fae5; color: #065f46; border: 1px solid #10b981;{% elif message.tags == 'error' %}background: #fee2e2; color: #991b1b; border: 1px solid #dc2626;{% else %}background: #dbeafe; color: #1e40af; border: 1px solid #3b82f6;{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
    
    <div style="background: #ecfeff; padding: 16px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #06b6d4;">
        <div style="font-size: 14px; color: #0e7490; margin-bottom: 8px;"><strong>Current Account Status</strong></div>
        <div style="font-size: 13px; color: #0e7490;">
            Funding: {{ account.funding|floatformat:0 }}<br>
            Exchange Balance: {{ account.exchange_balance|floatformat:0 }}<br>
            Client PnL: <span class="{% if client_pnl > 0 %}positive{% elif client_pnl < 0 %}negative{% endif %}">{{ client_pnl|floatformat:0 }}</span><br>
            My Share: {{ my_share|floatformat:0 }}
        </div>
    </div>
    
    <div style="background: #fef3c7; padding: 16px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #f59e0b;">
        <div style="font-size: 13px; color: #92400e;">
            <strong>Payment Recording:</strong> This records the payment in the audit trail. 
            Optionally, you can update the exchange balance if this is a settlement payment.
        </div>
    </div>
    
    <form method="post">
        {% csrf_token %}
        {% if form.errors %}
            <div style="background: #fee2e2; color: #991b1b; padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dc2626;">
                {% for field, errors in form.errors.items %}
                    {% for error in errors %}
                        <div>{{ error }}</div>
                    {% endfor %}
                {% endfor %}
            </div>
        {% endif %}
        
        <div class="form-row">
            <label class="field-label">Payment Direction *</label>
            {{ form.payment_direction }}
            {% if form.payment_direction.errors %}
                <div style="color: var(--danger); font-size: 13px; margin-top: 4px;">{{ form.payment_direction.errors }}</div>
            {% endif %}
        </div>
        
        <div class="form-row">
            <label class="field-label">Amount *</label>
            {{ form.amount }}
            <div style="font-size: 13px; color: var(--muted); margin-top: 4px;">
                Amount in smallest currency unit (e.g., paise for rupees)
            </div>
            {% if form.amount.errors %}
                <div style="color: var(--danger); font-size: 13px; margin-top: 4px;">{{ form.amount.errors }}</div>
            {% endif %}
        </div>
        
        <div class="form-row">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                {{ form.update_exchange_balance }}
                <span class="field-label" style="margin: 0;">Update Exchange Balance (Settlement)</span>
            </label>
            <div style="font-size: 13px; color: var(--muted); margin-top: 4px; margin-left: 26px;">
                Check this if this payment settles the account (reduces PnL)
            </div>
        </div>
        
        <div class="form-row" id="new-balance-row" style="display: none;">
            <label class="field-label">New Exchange Balance</label>
            {{ form.new_exchange_balance }}
            <div style="font-size: 13px; color: var(--muted); margin-top: 4px;">
                Enter the new exchange balance after this payment
            </div>
            {% if form.new_exchange_balance.errors %}
                <div style="color: var(--danger); font-size: 13px; margin-top: 4px;">{{ form.new_exchange_balance.errors }}</div>
            {% endif %}
        </div>
        
        <div class="form-row">
            <label class="field-label">Notes (Optional)</label>
            {{ form.notes }}
        </div>
        
        <button type="submit" class="btn btn-primary mt-3">Record Payment</button>
        <a href="{% url 'pending_summary' %}" class="btn mt-3" style="margin-left: 8px;">Cancel</a>
    </form>
</div>

<script>
// Show/hide new balance field based on checkbox
document.addEventListener('DOMContentLoaded', function() {
    const updateBalanceCheckbox = document.querySelector('input[name="update_exchange_balance"]');
    const newBalanceRow = document.getElementById('new-balance-row');
    const newBalanceInput = document.querySelector('input[name="new_exchange_balance"]');
    
    if (updateBalanceCheckbox && newBalanceRow) {
        updateBalanceCheckbox.addEventListener('change', function() {
            if (this.checked) {
                newBalanceRow.style.display = 'block';
                if (newBalanceInput) {
                    newBalanceInput.required = true;
                    // Pre-fill with current balance
                    newBalanceInput.value = {{ account.exchange_balance }};
                }
            } else {
                newBalanceRow.style.display = 'none';
                if (newBalanceInput) {
                    newBalanceInput.required = false;
                    newBalanceInput.value = '';
                }
            }
        });
    }
});
</script>
{% endblock %}

