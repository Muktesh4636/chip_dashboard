{% extends "core/base.html" %}

{% block title %}Pending Payments Â· Transaction Hub{% endblock %}
{% block page_title %}Pending Payments{% endblock %}
{% block page_subtitle %}Two separate sections: Clients owe you vs You owe clients{% endblock %}

{% block content %}
<div style="background: var(--bg-content); border-radius: 8px; padding: 20px; border: 1px solid var(--border); margin-bottom: 24px;">
    <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
        <button onclick="showSection('clients-owe')" id="btn-clients-owe" class="btn btn-primary" style="background: var(--accent);">
        Clients Owe You
    </button>
        <button onclick="showSection('you-owe')" id="btn-you-owe" class="btn" style="background: var(--bg-content);">
        You Owe Clients
    </button>
    </div>
</div>

<!-- Summary Cards -->
<div class="card-grid" style="margin-bottom: 24px;">
    <div class="card">
        <div class="card-title">Total Clients Owe</div>
        <div class="card-value negative">{{ total_clients_owe|floatformat:0 }}</div>
        <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">Your Share: {{ total_my_share_clients_owe|floatformat:0 }}</div>
        </div>
    <div class="card">
        <div class="card-title">Total You Owe</div>
        <div class="card-value negative">{{ total_you_owe|floatformat:0 }}</div>
        <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">Your Share: {{ total_my_share_you_owe|floatformat:0 }}</div>
    </div>
        </div>

<!-- Clients Owe You Section -->
<div id="section-clients-owe" class="section-content">
    <div style="background: var(--bg-content); border-radius: 8px; padding: 24px; border: 1px solid var(--border); margin-bottom: 24px;">
        <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">Clients Owe You</h3>
        <p style="color: var(--muted); margin-bottom: 16px;">
            These clients are in LOSS (Client_PnL &lt; 0). They owe you the full loss amount. 
            Your share is {{ total_my_share_clients_owe|floatformat:0 }}.
        </p>
        
        {% if clients_owe_you %}
        <div class="table-wrapper">
            <table>
            <thead>
            <tr>
                <th>Client</th>
                <th>Exchange</th>
                <th>Funding</th>
                <th>Exchange Balance</th>
                <th>Client PnL</th>
                <th>Amount Owed</th>
                <th>My Share</th>
                <th>My %</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
                {% for item in clients_owe_you %}
                <tr>
                    <td>
                        <a href="{% url 'client_detail' item.client.pk %}" style="color: var(--accent); text-decoration: none;">
                            {{ item.client.name }}{% if item.client.code %} ({{ item.client.code }}){% endif %}
                        </a>
                    </td>
                    <td>{{ item.exchange.name }}{% if item.exchange.code %} ({{ item.exchange.code }}){% endif %}</td>
                    <td>{{ item.account.funding|floatformat:0 }}</td>
                    <td>{{ item.account.exchange_balance|floatformat:0 }}</td>
                    <td>
                        <span class="negative">{{ item.client_pnl|floatformat:0 }}</span>
                    </td>
                    <td><strong>{{ item.amount_owed|floatformat:0 }}</strong></td>
                    <td>{{ item.my_share_amount|floatformat:0 }}</td>
                    <td>{{ item.account.my_percentage }}%</td>
                    <td>
                        <a href="{% url 'record_payment' item.account.pk %}?redirect_to=pending_summary" class="btn btn-sm btn-primary" style="margin-right: 4px;">Record Payment</a>
                        <a href="{% url 'exchange_account_detail' item.account.pk %}" class="btn btn-sm">View Account</a>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
                    {% else %}
        <div style="text-align: center; padding: 40px; color: var(--muted);">
            <div style="font-size: 16px; margin-bottom: 8px;">No clients owe you</div>
            <div style="font-size: 14px;">All clients are either settled or in profit</div>
</div>
            {% endif %}
        </div>
    </div>

<!-- You Owe Clients Section -->
<div id="section-you-owe" class="section-content" style="display: none;">
    <div style="background: var(--bg-content); border-radius: 8px; padding: 24px; border: 1px solid var(--border); margin-bottom: 24px;">
        <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">You Owe Clients</h3>
        <p style="color: var(--muted); margin-bottom: 16px;">
            These clients are in PROFIT (Client_PnL &gt; 0). You owe them your share of the profit. 
            Total your share: {{ total_my_share_you_owe|floatformat:0 }}.
        </p>
        
        {% if you_owe_clients %}
        <div class="table-wrapper">
            <table>
            <thead>
            <tr>
                <th>Client</th>
                <th>Exchange</th>
                <th>Funding</th>
                <th>Exchange Balance</th>
                <th>Client PnL</th>
                <th>Client Profit</th>
                <th>My Share (You Pay)</th>
                <th>My %</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
                {% for item in you_owe_clients %}
                <tr>
                    <td>
                        <a href="{% url 'client_detail' item.client.pk %}" style="color: var(--accent); text-decoration: none;">
                            {{ item.client.name }}{% if item.client.code %} ({{ item.client.code }}){% endif %}
                        </a>
                    </td>
                    <td>{{ item.exchange.name }}{% if item.exchange.code %} ({{ item.exchange.code }}){% endif %}</td>
                    <td>{{ item.account.funding|floatformat:0 }}</td>
                    <td>{{ item.account.exchange_balance|floatformat:0 }}</td>
                    <td>
                        <span class="positive">{{ item.client_pnl|floatformat:0 }}</span>
                    </td>
                    <td><strong>{{ item.amount_owed|floatformat:0 }}</strong></td>
                    <td><strong style="color: var(--danger);">{{ item.my_share_amount|floatformat:0 }}</strong></td>
                    <td>{{ item.account.my_percentage }}%</td>
                    <td>
                        <a href="{% url 'record_payment' item.account.pk %}?redirect_to=pending_summary" class="btn btn-sm btn-primary" style="margin-right: 4px;">Record Payment</a>
                        <a href="{% url 'exchange_account_detail' item.account.pk %}" class="btn btn-sm">View Account</a>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
        {% else %}
        <div style="text-align: center; padding: 40px; color: var(--muted);">
            <div style="font-size: 16px; margin-bottom: 8px;">You don't owe any clients</div>
            <div style="font-size: 14px;">All clients are either settled or in loss</div>
</div>
            {% endif %}
    </div>
</div>

<script>
function showSection(section) {
    // Hide all sections
    document.getElementById('section-clients-owe').style.display = 'none';
    document.getElementById('section-you-owe').style.display = 'none';
    
    // Reset button styles
    document.getElementById('btn-clients-owe').classList.remove('btn-primary');
    document.getElementById('btn-clients-owe').style.background = 'var(--bg-content)';
    document.getElementById('btn-you-owe').classList.remove('btn-primary');
    document.getElementById('btn-you-owe').style.background = 'var(--bg-content)';
    
    // Show selected section
    if (section === 'clients-owe') {
        document.getElementById('section-clients-owe').style.display = 'block';
        document.getElementById('btn-clients-owe').classList.add('btn-primary');
        document.getElementById('btn-clients-owe').style.background = 'var(--accent)';
    } else if (section === 'you-owe') {
        document.getElementById('section-you-owe').style.display = 'block';
        document.getElementById('btn-you-owe').classList.add('btn-primary');
        document.getElementById('btn-you-owe').style.background = 'var(--accent)';
    }
}
</script>
{% endblock %}
